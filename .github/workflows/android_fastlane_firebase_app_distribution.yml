name: Android Fastlane with Firebase App Distribution Workflow

on:
  push:
    branches:
      - master

jobs:
  distribute_to_firebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Ruby for fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4.7"
          bundler-cache: false
          working-directory: android

      - name: Prepare bundler & install gems
        working-directory: android
        env:
          BUNDLE_PATH: vendor/bundle
        run: |
          set -euo pipefail
          bundle lock --add-platform x86_64-linux || true
          bundle lock --add-platform ruby || true
          bundle install --path vendor/bundle --jobs 4 --retry 3 || true

      - name: Install kconv system-wide and set preload
        run: |
          set -euo pipefail
          gem install kconv --no-document || true
          echo "RUBYOPT will preload kconv during fastlane execution."

      - name: Make gradlew executable
        working-directory: android
        run: |
          if [ -f ./gradlew ]; then chmod +x ./gradlew; fi

      - name: Run fastlane (bundle exec preferred; fallback to system fastlane)
        working-directory: android
        env:
          FIREBASE_CLI_TOKEN: ${{ secrets.FIREBASE_CLI_TOKEN }}
          FASTLANE_DISABLE_UPDATE_CHECK: "1"
          RUBYOPT: "-r kconv"
          BUNDLE_PATH: vendor/bundle
        run: |
          set -euo pipefail
          echo "Attempt #1: bundle exec fastlane (preferred)"
          if bundle exec fastlane android firebase_distribution --verbose; then
            echo "fastlane succeeded via bundle exec"
            exit 0
          fi

          echo "bundle exec failed â€” attempt #2: try binstub"
          if bundle binstubs fastlane --force && [ -x ./bin/fastlane ]; then
            ./bin/fastlane android firebase_distribution --verbose && exit 0 || true
          fi

          echo "Attempt #3: install fastlane system gem (fallback) and run directly"
          gem install fastlane -v "2.229.0" --no-document || true
          fastlane android firebase_distribution --verbose || {
            echo "All fastlane attempts failed. Collecting diagnostics..."
            echo "---- bundle env ----"
            bundle env || true
            echo "---- gem list (fastlane) ----"
            gem list | grep fastlane || true
            if [ -f ./gradlew ]; then echo "---- gradle assembleRelease (stacktrace) ----" && ./gradlew assembleRelease --stacktrace || true; fi
            exit 1
          }
